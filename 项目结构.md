# è…¾å›¾ç‰‡åç«¯é¡¹ç›®ç»“æ„åˆ†æ

## 1. é¡¹ç›®æ¶æ„

è¿™æ˜¯ä¸€ä¸ªåŸºäº Spring Boot çš„åç«¯é¡¹ç›®ï¼Œé‡‡ç”¨äº†ç»å…¸çš„å¤šå±‚æ¶æ„è®¾è®¡ã€‚é¡¹ç›®åä¸º"è…¾å›¾ç‰‡åç«¯"(Teng Picture Backend)ï¼Œä¸»è¦æ˜¯ä¸€ä¸ªå›¾ç‰‡å¤„ç†ç›¸å…³çš„æœåŠ¡ã€‚

### æ¶æ„æµç¨‹å›¾

```mermaid
graph TD
    A[Controllerå±‚] --> B[Serviceå±‚]
    B --> C[Managerå±‚]
    C --> D[Mapperå±‚]
    D --> E[æ•°æ®åº“]
```

## 2. æ ¸å¿ƒç›®å½•ç»“æ„

```markdown
ğŸ“¦ teng-picture-backend
â”œâ”€â”€ ğŸ“‚ src/main/java/com/zhongyuan/tengpicturebackend
â”‚ â”œâ”€â”€ ğŸ“‚ controller // æ§åˆ¶å™¨å±‚ï¼šå¤„ç† HTTP è¯·æ±‚
â”‚ â”œâ”€â”€ ğŸ“‚ service // æœåŠ¡å±‚ï¼šä¸šåŠ¡é€»è¾‘å¤„ç†
â”‚ â”œâ”€â”€ ğŸ“‚ model // æ•°æ®æ¨¡å‹ï¼šå®ä½“ç±»
â”‚ â”œâ”€â”€ ğŸ“‚ manager // ç®¡ç†å±‚ï¼šå¤æ‚ä¸šåŠ¡å¤„ç†
â”‚ â”œâ”€â”€ ğŸ“‚ mapper // æ•°æ®è®¿é—®å±‚ï¼šMyBatis æ˜ å°„
â”‚ â”œâ”€â”€ ğŸ“‚ config // é…ç½®ç±»
â”‚ â”œâ”€â”€ ğŸ“‚ aop // é¢å‘åˆ‡é¢ç¼–ç¨‹
â”‚ â”œâ”€â”€ ğŸ“‚ annotation // è‡ªå®šä¹‰æ³¨è§£
â”‚ â”œâ”€â”€ ğŸ“‚ constant // å¸¸é‡å®šä¹‰
â”‚ â”œâ”€â”€ ğŸ“‚ common // å…¬å…±ç»„ä»¶
â”‚ â””â”€â”€ ğŸ“‚ exception // å¼‚å¸¸å¤„ç†
â”œâ”€â”€ ğŸ“‚ resources // é…ç½®æ–‡ä»¶
â””â”€â”€ ğŸ“‚ sql // æ•°æ®åº“è„šæœ¬
```

## 3. æŠ€æœ¯æ ˆåˆ†æ

1. **æ ¸å¿ƒæ¡†æ¶**ï¼šSpring Boot
2. **æŒä¹…å±‚**ï¼šMyBatis
3. **æ•°æ®åº“**ï¼šMySQL
4. **é¡¹ç›®æ„å»º**ï¼šMaven
5. **åˆ‡é¢ç¼–ç¨‹**ï¼šSpring AOP

## 4. åŠŸèƒ½æ¨¡å—åˆ’åˆ†

### 4.1 åŸºç¡€æ¶æ„æ¨¡å—

```mermaid
graph LR
    A[é…ç½®æ¨¡å—] --> B[å¼‚å¸¸å¤„ç†]
    A --> C[AOPåˆ‡é¢]
    A --> D[æ³¨è§£æ”¯æŒ]
    A --> E[å¸¸é‡å®šä¹‰]
```

### 4.2 ä¸šåŠ¡æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[Controller]
    B --> C[æƒé™æ ¡éªŒ/AOP]
    C --> D[Serviceä¸šåŠ¡å¤„ç†]
    D --> E[Managerå¤æ‚ä¸šåŠ¡]
    E --> F[Mapperæ•°æ®è®¿é—®]
    F --> G[æ•°æ®åº“]
```

## 5. å…³é”®ç‰¹æ€§

1. **AOP åˆ‡é¢**ï¼š

   - ä½äº `aop` åŒ…ä¸‹
   - å¯èƒ½ç”¨äºæ—¥å¿—è®°å½•ã€æƒé™éªŒè¯ã€æ€§èƒ½ç›‘æ§ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹

2. **è‡ªå®šä¹‰æ³¨è§£**ï¼š

   - ä½äº `annotation` åŒ…ä¸‹
   - ç”¨äºåŠŸèƒ½æ ‡è®°å’Œè¡Œä¸ºæ§åˆ¶

3. **å¼‚å¸¸å¤„ç†**ï¼š

   - ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
   - è§„èŒƒçš„é”™è¯¯å“åº”

4. **é€šç”¨ç»„ä»¶**ï¼š
   - ä½äº `common` åŒ…ä¸‹
   - åŒ…å«å·¥å…·ç±»å’Œé€šç”¨åŠŸèƒ½

## 6. ä»£ç è§„èŒƒå’Œæœ€ä½³å®è·µ

1. **åˆ†å±‚æ¶æ„**ï¼š

   - æ¸…æ™°çš„èŒè´£åˆ’åˆ†
   - è‰¯å¥½çš„ä»£ç ç»„ç»‡

2. **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼š

   - é›†ä¸­çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
   - æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”

3. **é…ç½®ç®¡ç†**ï¼š
   - é›†ä¸­çš„é…ç½®ç±»ç®¡ç†
   - ç¯å¢ƒéš”ç¦»

## 7. å»ºè®®æ”¹è¿›æ–¹å‘

1. **æ–‡æ¡£å®Œå–„**ï¼š

   - æ·»åŠ è¯¦ç»†çš„ API æ–‡æ¡£
   - å®Œå–„å¼€å‘æ–‡æ¡£

2. **æµ‹è¯•è¦†ç›–**ï¼š

   - å¢åŠ å•å…ƒæµ‹è¯•
   - æ·»åŠ é›†æˆæµ‹è¯•

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š

   - æ·»åŠ ç¼“å­˜æœºåˆ¶
   - ä¼˜åŒ–æ•°æ®åº“è®¿é—®

4. **å®‰å…¨åŠ å¼º**ï¼š
   - å®Œå–„æƒé™æ§åˆ¶
   - åŠ å¼ºæ•°æ®éªŒè¯

## 8. æ¥å£è¯´æ˜å’Œä¸šåŠ¡æµç¨‹

### 8.1 ç”¨æˆ·æ¨¡å— (UserController)

#### 8.1.1 æ•°æ®æ¨¡å‹

- **DTO (Data Transfer Object)**

  - `UserRegisterRequest`: ç”¨æˆ·æ³¨å†Œè¯·æ±‚å‚æ•°
  - `UserLoginRequest`: ç”¨æˆ·ç™»å½•è¯·æ±‚å‚æ•°
  - `UserAddRequest`: ç®¡ç†å‘˜æ·»åŠ ç”¨æˆ·è¯·æ±‚å‚æ•°
  - `UserUpdateRequest`: ç”¨æˆ·ä¿¡æ¯æ›´æ–°è¯·æ±‚å‚æ•°
  - `UserQueryRequest`: ç”¨æˆ·æŸ¥è¯¢è¯·æ±‚å‚æ•°

- **VO (View Object)**
  - `LoginUserVo`: ç™»å½•ç”¨æˆ·è§†å›¾å¯¹è±¡ï¼ŒåŒ…å«è„±æ•åçš„ç”¨æˆ·ä¿¡æ¯
  - `UserVo`: ç”¨æˆ·ä¿¡æ¯è§†å›¾å¯¹è±¡

#### 8.1.2 æ¥å£æ¸…å•

1. **ç”¨æˆ·æ³¨å†Œ**

   ```
   POST /user/register
   ```

   - åŠŸèƒ½ï¼šæ–°ç”¨æˆ·æ³¨å†Œ
   - å‚æ•°ï¼šUserRegisterRequest
   - è¿”å›ï¼šç”¨æˆ· ID
   - æµç¨‹ï¼š
     1. å‚æ•°æ ¡éªŒ
     2. å¯†ç åŠ å¯†
     3. åˆ›å»ºç”¨æˆ·
     4. è¿”å›ç”¨æˆ· ID

2. **ç”¨æˆ·ç™»å½•**

   ```
   POST /user/login
   ```

   - åŠŸèƒ½ï¼šç”¨æˆ·ç™»å½•
   - å‚æ•°ï¼šUserLoginRequest
   - è¿”å›ï¼šLoginUserVo
   - æµç¨‹ï¼š
     1. å‚æ•°æ ¡éªŒ
     2. å¯†ç éªŒè¯
     3. è®°å½•ç™»å½•æ€
     4. è¿”å›è„±æ•ç”¨æˆ·ä¿¡æ¯

3. **è·å–å½“å‰ç™»å½•ç”¨æˆ·**

   ```
   GET /user/get/login
   ```

   - åŠŸèƒ½ï¼šè·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
   - è¿”å›ï¼šLoginUserVo

4. **ç”¨æˆ·æ³¨é”€**

   ```
   POST /user/logout
   ```

   - åŠŸèƒ½ï¼šç”¨æˆ·æ³¨é”€ç™»å½•
   - æµç¨‹ï¼šæ¸…é™¤ç™»å½•æ€

5. **ç®¡ç†å‘˜æ¥å£**
   ```
   POST /user/add          # æ·»åŠ ç”¨æˆ·
   GET /user/get          # è·å–ç”¨æˆ·ä¿¡æ¯
   POST /user/delete      # åˆ é™¤ç”¨æˆ·
   POST /user/update      # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
   POST /user/list/page/vo # åˆ†é¡µè·å–ç”¨æˆ·åˆ—è¡¨
   ```

### 8.2 å›¾ç‰‡æ¨¡å— (PictureController)

#### 8.2.1 æ•°æ®æ¨¡å‹

- **DTO**

  - `PictureUploadRequest`: å›¾ç‰‡ä¸Šä¼ è¯·æ±‚
  - `PictureUpdateRequest`: å›¾ç‰‡æ›´æ–°è¯·æ±‚
  - `PictureQueryRequest`: å›¾ç‰‡æŸ¥è¯¢è¯·æ±‚
  - `PictureReviewRequest`: å›¾ç‰‡å®¡æ ¸è¯·æ±‚
  - `PictureEditRequest`: å›¾ç‰‡ç¼–è¾‘è¯·æ±‚

- **VO**
  - `PictureVo`: å›¾ç‰‡ä¿¡æ¯è§†å›¾å¯¹è±¡
  - `PictureTagCategory`: å›¾ç‰‡æ ‡ç­¾å’Œåˆ†ç±»

#### 8.2.2 æ¥å£æ¸…å•

1. **å›¾ç‰‡ä¸Šä¼ **

   ```
   POST /picture/upload
   ```

   - åŠŸèƒ½ï¼šä¸Šä¼ æ–°å›¾ç‰‡
   - å‚æ•°ï¼šMultipartFile, PictureUploadRequest
   - è¿”å›ï¼šPictureVo
   - æµç¨‹ï¼š
     1. æ–‡ä»¶æ ¡éªŒ
     2. ä¸Šä¼ å¤„ç†
     3. ä¿å­˜å›¾ç‰‡ä¿¡æ¯
     4. è¿”å›å›¾ç‰‡è§†å›¾

2. **å›¾ç‰‡ç®¡ç†**

   ```
   POST /picture/update   # æ›´æ–°å›¾ç‰‡ä¿¡æ¯ï¼ˆç®¡ç†å‘˜ï¼‰
   GET /picture/get      # è·å–å›¾ç‰‡è¯¦æƒ…ï¼ˆç®¡ç†å‘˜ï¼‰
   POST /picture/delete  # åˆ é™¤å›¾ç‰‡
   POST /picture/review  # å®¡æ ¸å›¾ç‰‡ï¼ˆç®¡ç†å‘˜ï¼‰
   POST /picture/edit    # ç¼–è¾‘å›¾ç‰‡
   ```

3. **å›¾ç‰‡æŸ¥è¯¢**
   ```
   GET /picture/get/vo           # è·å–å›¾ç‰‡è¯¦æƒ…
   POST /picture/list/page/vo    # åˆ†é¡µæŸ¥è¯¢å›¾ç‰‡
   GET /picture/tag_category     # è·å–æ ‡ç­¾å’Œåˆ†ç±»
   ```

### 8.3 ä¸šåŠ¡æµç¨‹å›¾

#### 8.3.1 å›¾ç‰‡ä¸Šä¼ æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·] --> B[ä¸Šä¼ å›¾ç‰‡]
    B --> C{æ–‡ä»¶æ ¡éªŒ}
    C -->|å¤±è´¥| D[è¿”å›é”™è¯¯]
    C -->|æˆåŠŸ| E[ä¿å­˜æ–‡ä»¶]
    E --> F[åˆ›å»ºå›¾ç‰‡è®°å½•]
    F --> G[ç­‰å¾…å®¡æ ¸]
    G --> H{å®¡æ ¸ç»“æœ}
    H -->|é€šè¿‡| I[å…¬å¼€å±•ç¤º]
    H -->|æ‹’ç»| J[ä»…ä½œè€…å¯è§]
```

#### 8.3.2 ç”¨æˆ·è®¤è¯æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·] --> B[è¾“å…¥è´¦å·å¯†ç ]
    B --> C{éªŒè¯ä¿¡æ¯}
    C -->|å¤±è´¥| D[è¿”å›é”™è¯¯]
    C -->|æˆåŠŸ| E[ç”Ÿæˆç™»å½•æ€]
    E --> F[è¿”å›ç”¨æˆ·ä¿¡æ¯]
    F --> G[è®¿é—®å—ä¿æŠ¤èµ„æº]
    G --> H{æƒé™æ£€æŸ¥}
    H -->|æœ‰æƒé™| I[å¤„ç†è¯·æ±‚]
    H -->|æ— æƒé™| J[è¿”å›æœªæˆæƒ]
```

#### 8.3.3 å›¾ç‰‡å®¡æ ¸æµç¨‹

```mermaid
flowchart TD
    A[ç®¡ç†å‘˜] --> B[æŸ¥çœ‹å¾…å®¡æ ¸å›¾ç‰‡]
    B --> C{å®¡æ ¸æ“ä½œ}
    C -->|é€šè¿‡| D[æ›´æ–°çŠ¶æ€ä¸ºé€šè¿‡]
    C -->|æ‹’ç»| E[æ›´æ–°çŠ¶æ€ä¸ºæ‹’ç»]
    D --> F[è®°å½•å®¡æ ¸ä¿¡æ¯]
    E --> F
    F --> G[é€šçŸ¥ç”¨æˆ·]
```

## 9. å›¾ç‰‡æ¨¡å—è¯¦ç»†ä¸šåŠ¡æµç¨‹

### 9.1 æ•°æ®ç»“æ„

#### 9.1.1 æ ¸å¿ƒå®ä½“ï¼ˆPictureï¼‰

```java
public class Picture {
    private Long id;                // å›¾ç‰‡ID
    private String url;            // å›¾ç‰‡URL
    private String name;           // å›¾ç‰‡åç§°
    private String introduction;   // å›¾ç‰‡ç®€ä»‹
    private String category;       // åˆ†ç±»
    private String tags;          // æ ‡ç­¾ï¼ˆJSONæ•°ç»„ï¼‰
    private Long picSize;         // å›¾ç‰‡å¤§å°
    private Integer picWidth;     // å®½åº¦
    private Integer picHeight;    // é«˜åº¦
    private Double picScale;      // å®½é«˜æ¯”
    private String picFormat;     // å›¾ç‰‡æ ¼å¼
    private Long userId;          // åˆ›å»ºç”¨æˆ·ID
    private Integer reviewStatus; // å®¡æ ¸çŠ¶æ€ï¼ˆ0-å¾…å®¡æ ¸,1-é€šè¿‡,2-æ‹’ç»ï¼‰
    private String reviewMessage; // å®¡æ ¸ä¿¡æ¯
    private Long reviewerId;      // å®¡æ ¸äººID
    private Date reviewTime;      // å®¡æ ¸æ—¶é—´
    private Date createTime;      // åˆ›å»ºæ—¶é—´
    private Date editTime;        // ç¼–è¾‘æ—¶é—´
    private Date updateTime;      // æ›´æ–°æ—¶é—´
}
```

### 9.2 è¯¦ç»†ä¸šåŠ¡æµç¨‹

#### 9.2.1 å›¾ç‰‡ä¸Šä¼ æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·] --> B[é€‰æ‹©å›¾ç‰‡æ–‡ä»¶]
    B --> C[ä¸Šä¼ è¯·æ±‚]
    C --> D{æ–‡ä»¶éªŒè¯}
    D -->|éªŒè¯å¤±è´¥| E[è¿”å›é”™è¯¯]
    D -->|éªŒè¯é€šè¿‡| F[è·å–å›¾ç‰‡ä¿¡æ¯]
    F --> G[æå–å…ƒæ•°æ®]
    G --> H[ä¿å­˜å›¾ç‰‡æ–‡ä»¶]
    H --> I[åˆ›å»ºå›¾ç‰‡è®°å½•]
    I --> J[è®¾ç½®å¾…å®¡æ ¸çŠ¶æ€]
    J --> K[è¿”å›å›¾ç‰‡ä¿¡æ¯]
```

**è¯¦ç»†æ­¥éª¤**ï¼š

1. **æ–‡ä»¶éªŒè¯**

   - æ£€æŸ¥æ–‡ä»¶å¤§å°
   - éªŒè¯æ–‡ä»¶æ ¼å¼
   - æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§

2. **å…ƒæ•°æ®æå–**

   - è·å–å›¾ç‰‡å°ºå¯¸
   - è®¡ç®—å®½é«˜æ¯”
   - è·å–æ–‡ä»¶æ ¼å¼
   - è®°å½•æ–‡ä»¶å¤§å°

3. **æ•°æ®å­˜å‚¨**
   - ä¿å­˜å›¾ç‰‡æ–‡ä»¶åˆ°å­˜å‚¨ç³»ç»Ÿ
   - ç”Ÿæˆè®¿é—® URL
   - åˆ›å»ºæ•°æ®åº“è®°å½•

#### 9.2.2 å›¾ç‰‡å®¡æ ¸æµç¨‹

```mermaid
flowchart TD
    A[ç®¡ç†å‘˜] --> B[æŸ¥çœ‹å¾…å®¡æ ¸åˆ—è¡¨]
    B --> C[é€‰æ‹©å›¾ç‰‡]
    C --> D[æŸ¥çœ‹å›¾ç‰‡è¯¦æƒ…]
    D --> E{å®¡æ ¸å†³å®š}
    E -->|é€šè¿‡| F[æ›´æ–°çŠ¶æ€ä¸ºé€šè¿‡]
    E -->|æ‹’ç»| G[æ›´æ–°çŠ¶æ€ä¸ºæ‹’ç»]
    F --> H[è®°å½•å®¡æ ¸ä¿¡æ¯]
    G --> H
    H --> I[æ›´æ–°å®¡æ ¸æ—¶é—´]
    I --> J[æ›´æ–°å®¡æ ¸äººID]
```

**å®¡æ ¸çŠ¶æ€æµè½¬**ï¼š

- å¾…å®¡æ ¸(0) -> é€šè¿‡(1)
- å¾…å®¡æ ¸(0) -> æ‹’ç»(2)

#### 9.2.3 å›¾ç‰‡ç®¡ç†æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·/ç®¡ç†å‘˜] --> B{æ“ä½œç±»å‹}
    B -->|ç¼–è¾‘| C[æ›´æ–°å›¾ç‰‡ä¿¡æ¯]
    B -->|åˆ é™¤| D[åˆ é™¤å›¾ç‰‡]
    B -->|æŸ¥è¯¢| E[æŸ¥è¯¢å›¾ç‰‡]
    C --> F[æƒé™æ£€æŸ¥]
    D --> F
    F -->|é€šè¿‡| G[æ‰§è¡Œæ“ä½œ]
    F -->|å¤±è´¥| H[è¿”å›é”™è¯¯]
    G --> I[è¿”å›ç»“æœ]
```

**æƒé™æ§åˆ¶**ï¼š

1. æ™®é€šç”¨æˆ·
   - åªèƒ½æ“ä½œè‡ªå·±çš„å›¾ç‰‡
   - åªèƒ½æŸ¥çœ‹å·²å®¡æ ¸é€šè¿‡çš„å›¾ç‰‡
2. ç®¡ç†å‘˜
   - å¯ä»¥æ“ä½œæ‰€æœ‰å›¾ç‰‡
   - å¯ä»¥æŸ¥çœ‹æ‰€æœ‰çŠ¶æ€çš„å›¾ç‰‡

#### 9.2.4 å›¾ç‰‡æŸ¥è¯¢æµç¨‹

```mermaid
flowchart TD
    A[è¯·æ±‚] --> B[æ„å»ºæŸ¥è¯¢æ¡ä»¶]
    B --> C{ç”¨æˆ·è§’è‰²}
    C -->|æ™®é€šç”¨æˆ·| D[æ·»åŠ å®¡æ ¸é€šè¿‡è¿‡æ»¤]
    C -->|ç®¡ç†å‘˜| E[å…¨éƒ¨å¯è§]
    D --> F[æ‰§è¡ŒæŸ¥è¯¢]
    E --> F
    F --> G[è½¬æ¢ä¸ºVO]
    G --> H[è¿”å›ç»“æœ]
```

**æŸ¥è¯¢å‚æ•°**ï¼š

- åˆ†ç±»ç­›é€‰
- æ ‡ç­¾ç­›é€‰
- åˆ›å»ºæ—¶é—´èŒƒå›´
- å®¡æ ¸çŠ¶æ€
- å…³é”®è¯æœç´¢

### 9.3 å…³é”®ä¸šåŠ¡è§„åˆ™

1. **å›¾ç‰‡æ ¼å¼æ§åˆ¶**

   - æ”¯æŒçš„æ ¼å¼ï¼šJPGã€PNGã€GIF ç­‰
   - æœ€å¤§æ–‡ä»¶å¤§å°é™åˆ¶
   - å›¾ç‰‡å°ºå¯¸é™åˆ¶

2. **å®¡æ ¸æœºåˆ¶**

   - æ‰€æœ‰ä¸Šä¼ å›¾ç‰‡é»˜è®¤å¾…å®¡æ ¸
   - åªæœ‰ç®¡ç†å‘˜å¯ä»¥è¿›è¡Œå®¡æ ¸
   - å®¡æ ¸éœ€è¦è®°å½•æ“ä½œäººå’Œæ—¶é—´

3. **æƒé™æ§åˆ¶**

   - åŸºäºç”¨æˆ·è§’è‰²çš„è®¿é—®æ§åˆ¶
   - æ“ä½œæƒé™éªŒè¯
   - æ•°æ®è®¿é—®èŒƒå›´æ§åˆ¶

4. **æ•°æ®å±•ç¤º**
   - åˆ†é¡µæŸ¥è¯¢
   - æ¡ä»¶è¿‡æ»¤
   - æ’åºæ”¯æŒ

### 9.4 å¼‚å¸¸å¤„ç†

1. **ä¸Šä¼ å¼‚å¸¸**

   - æ–‡ä»¶æ ¼å¼é”™è¯¯
   - æ–‡ä»¶å¤§å°è¶…é™
   - å­˜å‚¨å¤±è´¥

2. **ä¸šåŠ¡å¼‚å¸¸**

   - æƒé™ä¸è¶³
   - èµ„æºä¸å­˜åœ¨
   - å‚æ•°é”™è¯¯

3. **ç³»ç»Ÿå¼‚å¸¸**
   - æœåŠ¡å™¨é”™è¯¯
   - å­˜å‚¨ç³»ç»Ÿå¼‚å¸¸
   - æ•°æ®åº“å¼‚å¸¸

### ä¼˜åŒ–ç‚¹

1. å›¾ç‰‡æŸ¥è¯¢ä¼˜åŒ–ï¼š
   - redis ç¼“å­˜ä¼˜åŒ–
   - æœ¬åœ°ç¼“å­˜ä¼˜åŒ–(ç­‰å¾…å®ç°)

## 10. WebSocket æ¨¡å—è¯¦ç»†ä¸šåŠ¡æµç¨‹

### 10.1 WebSocket æ¶æ„æ¦‚è¿°

é¡¹ç›®ä¸­çš„ WebSocket æ¨¡å—ä¸»è¦ç”¨äºå®ç°å›¾ç‰‡ååŒç¼–è¾‘åŠŸèƒ½ï¼Œå…è®¸å¤šä¸ªç”¨æˆ·åŒæ—¶æŸ¥çœ‹å’Œç¼–è¾‘åŒä¸€å¼ å›¾ç‰‡ï¼Œå¹¶å®æ—¶åŒæ­¥ç¼–è¾‘æ“ä½œã€‚

#### 10.1.1 æ ¸å¿ƒç»„ä»¶

```mermaid
graph TD
    A[WsConfig] --> B[WsHandshakeInterceptor]
    A --> C[WsPictureEditHandler]
    C --> D[æ¶ˆæ¯å¤„ç†]
    B --> E[è¿æ¥éªŒè¯]
    D --> F[æ¶ˆæ¯å¹¿æ’­]
```

1. **WsConfig**: WebSocket é…ç½®ç±»ï¼Œæ³¨å†Œå¤„ç†å™¨å’Œæ‹¦æˆªå™¨
2. **WsHandshakeInterceptor**: æ¡æ‰‹æ‹¦æˆªå™¨ï¼Œè´Ÿè´£è¿æ¥éªŒè¯å’Œæƒé™æ£€æŸ¥
3. **WsPictureEditHandler**: æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¤„ç†å„ç±»ç¼–è¾‘æ“ä½œå’ŒçŠ¶æ€ç®¡ç†

### 10.2 æ•°æ®æ¨¡å‹

#### 10.2.1 æ¶ˆæ¯ç±»å‹æšä¸¾ (PictureEditMessageTypeEnum)

```java
public enum PictureEditMessageTypeEnum {
    INFO("å‘é€é€šçŸ¥", "INFO"),
    ERROR("å‘é€é”™è¯¯", "ERROR"),
    ENTER_EDIT("è¿›å…¥ç¼–è¾‘çŠ¶æ€", "ENTER_EDIT"),
    EXIT_EDIT("é€€å‡ºç¼–è¾‘çŠ¶æ€", "EXIT_EDIT"),
    EDIT_ACTION("æ‰§è¡Œç¼–è¾‘æ“ä½œ", "EDIT_ACTION");
}
```

#### 10.2.2 ç¼–è¾‘æ“ä½œæšä¸¾ (PictureEditActionEnum)

```java
public enum PictureEditActionEnum {
    ZOOM_IN("æ”¾å¤§æ“ä½œ", "ZOOM_IN"),
    ZOOM_OUT("ç¼©å°æ“ä½œ", "ZOOM_OUT"),
    ROTATE_LEFT("å·¦æ—‹æ“ä½œ", "ROTATE_LEFT"),
    ROTATE_RIGHT("å³æ—‹æ“ä½œ", "ROTATE_RIGHT");
}
```

#### 10.2.3 è¯·æ±‚æ¶ˆæ¯ (PictureEditRequestMessage)

```java
public class PictureEditRequestMessage {
    private String type;       // æ¶ˆæ¯ç±»å‹
    private String editAction; // ç¼–è¾‘åŠ¨ä½œ
}
```

#### 10.2.4 å“åº”æ¶ˆæ¯ (PictureEditResponseMessage)

```java
public class PictureEditResponseMessage {
    private String type;       // æ¶ˆæ¯ç±»å‹
    private String message;    // æ¶ˆæ¯å†…å®¹
    private String editAction; // ç¼–è¾‘åŠ¨ä½œ
    private UserVo user;       // ç”¨æˆ·ä¿¡æ¯
}
```

### 10.3 WebSocket é€šä¿¡æµç¨‹

#### 10.3.1 è¿æ¥å»ºç«‹æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Interceptor as WsHandshakeInterceptor
    participant Handler as WsPictureEditHandler

    Client->>Interceptor: å‘èµ·WebSocketè¿æ¥è¯·æ±‚
    Note right of Client: æºå¸¦pictureIdå‚æ•°

    Interceptor->>Interceptor: éªŒè¯è¯·æ±‚å‚æ•°
    Interceptor->>Interceptor: éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
    Interceptor->>Interceptor: éªŒè¯å›¾ç‰‡å­˜åœ¨æ€§
    Interceptor->>Interceptor: éªŒè¯ç©ºé—´æƒé™

    alt éªŒè¯é€šè¿‡
        Interceptor->>Handler: å…è®¸è¿æ¥
        Handler->>Handler: ä¿å­˜ä¼šè¯ä¿¡æ¯
        Handler->>Client: è¿æ¥æˆåŠŸ
        Handler->>Handler: å¹¿æ’­ç”¨æˆ·è¿›å…¥æ¶ˆæ¯
    else éªŒè¯å¤±è´¥
        Interceptor->>Client: æ‹’ç»è¿æ¥
    end
```

#### 10.3.2 æ¶ˆæ¯å¤„ç†æµç¨‹

```mermaid
flowchart TD
    A[æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯] --> B{æ¶ˆæ¯ç±»å‹}
    B -->|ENTER_EDIT| C[å¤„ç†è¿›å…¥ç¼–è¾‘çŠ¶æ€]
    B -->|EXIT_EDIT| D[å¤„ç†é€€å‡ºç¼–è¾‘çŠ¶æ€]
    B -->|EDIT_ACTION| E[å¤„ç†ç¼–è¾‘æ“ä½œ]
    B -->|å…¶ä»–| F[è¿”å›é”™è¯¯æ¶ˆæ¯]

    C --> G{å½“å‰æ˜¯å¦æœ‰äººç¼–è¾‘}
    G -->|å¦| H[è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºç¼–è¾‘è€…]
    G -->|æ˜¯| I[è¿”å›é”™è¯¯æ¶ˆæ¯]
    H --> J[å¹¿æ’­è¿›å…¥ç¼–è¾‘çŠ¶æ€æ¶ˆæ¯]

    D --> K{å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç¼–è¾‘è€…}
    K -->|æ˜¯| L[ç§»é™¤ç¼–è¾‘çŠ¶æ€]
    K -->|å¦| M[è¿”å›é”™è¯¯æ¶ˆæ¯]
    L --> N[å¹¿æ’­é€€å‡ºç¼–è¾‘çŠ¶æ€æ¶ˆæ¯]

    E --> O{å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç¼–è¾‘è€…}
    O -->|æ˜¯| P[éªŒè¯ç¼–è¾‘æ“ä½œæœ‰æ•ˆæ€§]
    O -->|å¦| Q[è¿”å›é”™è¯¯æ¶ˆæ¯]
    P --> R[å¹¿æ’­ç¼–è¾‘æ“ä½œæ¶ˆæ¯]
```

#### 10.3.3 å¹¿æ’­æœºåˆ¶

```mermaid
flowchart TD
    A[å¹¿æ’­æ¶ˆæ¯] --> B{æ¶ˆæ¯ç±»å‹}
    B -->|INFO| C[æ„å»ºINFOç±»å‹å“åº”]
    B -->|EDIT_ACTION| D[æ„å»ºEDIT_ACTIONç±»å‹å“åº”]

    C --> E[å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥ç”¨æˆ·]
    D --> F[å¹¿æ’­ç»™é™¤å‘é€è€…å¤–çš„æ‰€æœ‰ç”¨æˆ·]

    E --> G[æ›´æ–°å®¢æˆ·ç«¯çŠ¶æ€]
    F --> G
```

#### 10.3.4 è¿æ¥å…³é—­æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Handler as WsPictureEditHandler

    Client->>Handler: å…³é—­è¿æ¥

    Handler->>Handler: æ£€æŸ¥ç”¨æˆ·ç¼–è¾‘çŠ¶æ€

    alt ç”¨æˆ·æ­£åœ¨ç¼–è¾‘
        Handler->>Handler: ç§»é™¤ç¼–è¾‘çŠ¶æ€
    end

    Handler->>Handler: ç§»é™¤ä¼šè¯è®°å½•
    Handler->>Handler: å¹¿æ’­ç”¨æˆ·é€€å‡ºæ¶ˆæ¯
```

### 10.4 çŠ¶æ€ç®¡ç†

#### 10.4.1 ä¼šè¯ç®¡ç†

```mermaid
flowchart LR
    A[ä¼šè¯é›†åˆ] --> B["Map<Long, Set<WebSocketSession>>"]
    B --> C["pictureId -> ä¼šè¯é›†åˆ"]
    C --> D["ä¼šè¯1, ä¼šè¯2, ..."]
```

#### 10.4.2 ç¼–è¾‘çŠ¶æ€ç®¡ç†

```mermaid
flowchart LR
    A[ç¼–è¾‘çŠ¶æ€] --> B["Map<Long, Long>"]
    B --> C["pictureId -> userId"]
```

### 10.5 å¹¶å‘æ§åˆ¶

é¡¹ç›®é‡‡ç”¨äº†ä»¥ä¸‹æœºåˆ¶ç¡®ä¿åœ¨å¤šç”¨æˆ·åŒæ—¶ç¼–è¾‘æ—¶çš„æ•°æ®ä¸€è‡´æ€§ï¼š

1. **å•ä¸€ç¼–è¾‘è€…æ¨¡å¼**ï¼šåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªç”¨æˆ·å¯¹å›¾ç‰‡è¿›è¡Œç¼–è¾‘æ“ä½œ
2. **ConcurrentHashMap**ï¼šä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»å­˜å‚¨ä¼šè¯å’ŒçŠ¶æ€ä¿¡æ¯
3. **çŠ¶æ€é”å®šæœºåˆ¶**ï¼šç”¨æˆ·è¿›å…¥ç¼–è¾‘çŠ¶æ€åï¼Œå…¶ä»–ç”¨æˆ·æ— æ³•æ‰§è¡Œç¼–è¾‘æ“ä½œ

### 10.6 å¼‚å¸¸å¤„ç†

```mermaid
flowchart TD
    A[å¼‚å¸¸ç±»å‹] --> B[è¿æ¥å¼‚å¸¸]
    A --> C[æƒé™å¼‚å¸¸]
    A --> D[æ“ä½œå¼‚å¸¸]

    B --> E[è¿æ¥è¢«æ‹’ç»]
    C --> F[è¿”å›é”™è¯¯æ¶ˆæ¯]
    D --> G[æ“ä½œè¢«æ‹’ç»]

    E --> H[å®¢æˆ·ç«¯é‡è¿é€»è¾‘]
    F --> I[å®¢æˆ·ç«¯é”™è¯¯æç¤º]
    G --> J[å®¢æˆ·ç«¯çŠ¶æ€æ¢å¤]
```

### 10.7 å®Œæ•´é€šä¿¡æµç¨‹

```mermaid
sequenceDiagram
    participant Client1 as ç”¨æˆ·1
    participant Client2 as ç”¨æˆ·2
    participant Server as æœåŠ¡å™¨

    Client1->>Server: å»ºç«‹WebSocketè¿æ¥
    Server->>Client1: è¿æ¥æˆåŠŸ
    Server->>Client1: å½“å‰æ— äººç¼–è¾‘

    Client2->>Server: å»ºç«‹WebSocketè¿æ¥
    Server->>Client2: è¿æ¥æˆåŠŸ
    Server->>Client1: ç”¨æˆ·2è¿›å…¥ä¼šè¯
    Server->>Client2: å½“å‰æ— äººç¼–è¾‘

    Client1->>Server: è¯·æ±‚è¿›å…¥ç¼–è¾‘çŠ¶æ€
    Server->>Client1: è¿›å…¥ç¼–è¾‘çŠ¶æ€æˆåŠŸ
    Server->>Client2: ç”¨æˆ·1è¿›å…¥ç¼–è¾‘çŠ¶æ€

    Client1->>Server: æ‰§è¡Œæ”¾å¤§æ“ä½œ
    Server->>Client2: ç”¨æˆ·1æ‰§è¡Œæ”¾å¤§æ“ä½œ

    Client1->>Server: æ‰§è¡Œæ—‹è½¬æ“ä½œ
    Server->>Client2: ç”¨æˆ·1æ‰§è¡Œæ—‹è½¬æ“ä½œ

    Client2->>Server: è¯·æ±‚è¿›å…¥ç¼–è¾‘çŠ¶æ€
    Server->>Client2: æ‹’ç»ï¼Œå½“å‰æœ‰ç”¨æˆ·æ­£åœ¨ç¼–è¾‘

    Client1->>Server: é€€å‡ºç¼–è¾‘çŠ¶æ€
    Server->>Client1: é€€å‡ºç¼–è¾‘çŠ¶æ€æˆåŠŸ
    Server->>Client2: ç”¨æˆ·1é€€å‡ºç¼–è¾‘çŠ¶æ€

    Client2->>Server: è¯·æ±‚è¿›å…¥ç¼–è¾‘çŠ¶æ€
    Server->>Client2: è¿›å…¥ç¼–è¾‘çŠ¶æ€æˆåŠŸ
    Server->>Client1: ç”¨æˆ·2è¿›å…¥ç¼–è¾‘çŠ¶æ€

    Client1->>Server: å…³é—­è¿æ¥
    Server->>Client2: ç”¨æˆ·1é€€å‡ºä¼šè¯

    Client2->>Server: å…³é—­è¿æ¥
```

### 10.8 ä¼˜åŒ–å»ºè®®

1. **é‡è¿æœºåˆ¶**ï¼š

   - å®ç°å®¢æˆ·ç«¯æ–­çº¿é‡è¿åŠŸèƒ½
   - ä¿å­˜æ–­çº¿å‰çš„ç¼–è¾‘çŠ¶æ€

2. **ç¼–è¾‘é”è¶…æ—¶**ï¼š

   - æ·»åŠ ç¼–è¾‘çŠ¶æ€è¶…æ—¶æœºåˆ¶
   - é•¿æ—¶é—´æ— æ“ä½œè‡ªåŠ¨é‡Šæ”¾ç¼–è¾‘æƒé™

3. **æ“ä½œåˆå¹¶**ï¼š

   - å¯¹é¢‘ç¹çš„å°æ“ä½œè¿›è¡Œåˆå¹¶
   - å‡å°‘æ¶ˆæ¯ä¼ è¾“æ¬¡æ•°

4. **æ¶ˆæ¯å‹ç¼©**ï¼š
   - å¯¹å¤§å‹ç¼–è¾‘æ“ä½œçš„æ¶ˆæ¯è¿›è¡Œå‹ç¼©
   - ä¼˜åŒ–ç½‘ç»œä¼ è¾“æ•ˆç‡

## 11. å›¾ç‰‡æ¨¡å—è¯¦ç»†æ¶ˆæ¯æµè½¬ä¸ä¸šåŠ¡æµç¨‹

### 11.1 å›¾ç‰‡ä¸Šä¼ æµç¨‹è¯¦è§£

#### 11.1.1 è¯·æ±‚-å“åº”æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Controller as PictureController
    participant Service as PictureService
    participant Storage as å­˜å‚¨æœåŠ¡
    participant DB as æ•°æ®åº“

    Client->>Controller: ä¸Šä¼ å›¾ç‰‡è¯·æ±‚(MultipartFile, PictureUploadRequest)
    Controller->>Controller: å‚æ•°æ ¡éªŒ
    Controller->>Service: è°ƒç”¨uploadPictureæ–¹æ³•

    Service->>Service: æ–‡ä»¶æ ¼å¼æ ¡éªŒ
    Service->>Service: æ–‡ä»¶å¤§å°æ ¡éªŒ
    Service->>Service: æå–å›¾ç‰‡å…ƒæ•°æ®(å°ºå¯¸ã€æ ¼å¼ç­‰)

    Service->>Storage: ä¿å­˜å›¾ç‰‡æ–‡ä»¶
    Storage-->>Service: è¿”å›å­˜å‚¨URL

    Service->>Service: æ„å»ºPictureå®ä½“
    Service->>Service: è®¾ç½®é»˜è®¤å®¡æ ¸çŠ¶æ€(å¾…å®¡æ ¸)
    Service->>DB: ä¿å­˜å›¾ç‰‡è®°å½•
    DB-->>Service: ä¿å­˜æˆåŠŸ

    Service->>Service: æ„å»ºPictureVo
    Service-->>Controller: è¿”å›PictureVo
    Controller-->>Client: è¿”å›ä¸Šä¼ ç»“æœ
```

#### 11.1.2 æ•°æ®è½¬æ¢æµç¨‹

```mermaid
flowchart TD
    A[å®¢æˆ·ç«¯è¯·æ±‚] --> B[MultipartFile]
    A --> C[PictureUploadRequest]

    B --> D[æ–‡ä»¶å¤„ç†]
    C --> E[å‚æ•°æå–]

    D --> F[å›¾ç‰‡å…ƒæ•°æ®]
    E --> G[ä¸šåŠ¡å‚æ•°]

    F --> H[Pictureå®ä½“]
    G --> H

    H --> I[æ•°æ®åº“å­˜å‚¨]
    I --> J[Pictureå®ä½“]

    J --> K[PictureVoè½¬æ¢]
    K --> L[å“åº”ç»“æœ]
```

#### 11.1.3 å¼‚å¸¸å¤„ç†æµç¨‹

```mermaid
flowchart TD
    A[ä¸Šä¼ è¯·æ±‚] --> B{å‚æ•°æ ¡éªŒ}
    B -->|å¤±è´¥| C[æŠ›å‡ºPARAMS_ERROR]
    B -->|æˆåŠŸ| D{æ–‡ä»¶æ ¡éªŒ}

    D -->|å¤±è´¥| E[æŠ›å‡ºPARAMS_ERROR]
    D -->|æˆåŠŸ| F{å­˜å‚¨æ“ä½œ}

    F -->|å¤±è´¥| G[æŠ›å‡ºSYSTEM_ERROR]
    F -->|æˆåŠŸ| H{æ•°æ®åº“æ“ä½œ}

    H -->|å¤±è´¥| I[æŠ›å‡ºOPERATION_ERROR]
    H -->|æˆåŠŸ| J[è¿”å›æˆåŠŸç»“æœ]

    C --> K[ç»Ÿä¸€å¼‚å¸¸å¤„ç†]
    E --> K
    G --> K
    I --> K

    K --> L[è¿”å›é”™è¯¯å“åº”]
```

### 11.2 å›¾ç‰‡å®¡æ ¸æµç¨‹è¯¦è§£

#### 11.2.1 è¯·æ±‚-å“åº”æµç¨‹

```mermaid
sequenceDiagram
    participant Admin as ç®¡ç†å‘˜
    participant Controller as PictureController
    participant Service as PictureService
    participant DB as æ•°æ®åº“

    Admin->>Controller: å®¡æ ¸è¯·æ±‚(PictureReviewRequest)
    Controller->>Controller: æƒé™æ ¡éªŒ(@AuthCheck)
    Controller->>Controller: å‚æ•°æ ¡éªŒ

    Controller->>Service: è°ƒç”¨reviewPictureæ–¹æ³•

    Service->>DB: æŸ¥è¯¢å›¾ç‰‡ä¿¡æ¯
    DB-->>Service: è¿”å›å›¾ç‰‡æ•°æ®

    Service->>Service: éªŒè¯å›¾ç‰‡çŠ¶æ€
    Service->>Service: è®¾ç½®å®¡æ ¸çŠ¶æ€
    Service->>Service: è®¾ç½®å®¡æ ¸ä¿¡æ¯
    Service->>Service: è®¾ç½®å®¡æ ¸æ—¶é—´
    Service->>Service: è®¾ç½®å®¡æ ¸äººID

    Service->>DB: æ›´æ–°å›¾ç‰‡è®°å½•
    DB-->>Service: æ›´æ–°æˆåŠŸ

    Service-->>Controller: è¿”å›å¤„ç†ç»“æœ
    Controller-->>Admin: è¿”å›å®¡æ ¸ç»“æœ
```

#### 11.2.2 çŠ¶æ€è½¬æ¢æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> å¾…å®¡æ ¸: å›¾ç‰‡ä¸Šä¼ 
    å¾…å®¡æ ¸ --> å®¡æ ¸é€šè¿‡: ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
    å¾…å®¡æ ¸ --> å®¡æ ¸æ‹’ç»: ç®¡ç†å‘˜å®¡æ ¸æ‹’ç»

    å®¡æ ¸é€šè¿‡ --> [*]: ç»“æŸæµç¨‹
    å®¡æ ¸æ‹’ç» --> [*]: ç»“æŸæµç¨‹

    state å¾…å®¡æ ¸ {
        [*] --> ç­‰å¾…ç®¡ç†å‘˜æ“ä½œ
        ç­‰å¾…ç®¡ç†å‘˜æ“ä½œ --> æŸ¥çœ‹è¯¦æƒ…
        æŸ¥çœ‹è¯¦æƒ… --> åšå‡ºå†³å®š
        åšå‡ºå†³å®š --> [*]
    }
```

#### 11.2.3 å®¡æ ¸å†³ç­–æµç¨‹

```mermaid
flowchart TD
    A[å®¡æ ¸è¯·æ±‚] --> B{æƒé™æ£€æŸ¥}
    B -->|éç®¡ç†å‘˜| C[æ‹’ç»æ“ä½œ]
    B -->|ç®¡ç†å‘˜| D[è·å–å›¾ç‰‡ä¿¡æ¯]

    D --> E{å›¾ç‰‡æ˜¯å¦å­˜åœ¨}
    E -->|å¦| F[è¿”å›NOT_FOUND]
    E -->|æ˜¯| G{å½“å‰çŠ¶æ€}

    G -->|éå¾…å®¡æ ¸| H[çŠ¶æ€é”™è¯¯]
    G -->|å¾…å®¡æ ¸| I{å®¡æ ¸å†³å®š}

    I -->|é€šè¿‡| J[è®¾ç½®çŠ¶æ€ä¸ºé€šè¿‡]
    I -->|æ‹’ç»| K[è®¾ç½®çŠ¶æ€ä¸ºæ‹’ç»]

    J --> L[è®°å½•å®¡æ ¸ä¿¡æ¯]
    K --> L

    L --> M[æ›´æ–°æ•°æ®åº“]
    M --> N[è¿”å›å®¡æ ¸ç»“æœ]
```

### 11.3 å›¾ç‰‡æŸ¥è¯¢æµç¨‹è¯¦è§£

#### 11.3.1 è¯·æ±‚-å“åº”æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Controller as PictureController
    participant Service as PictureService
    participant DB as æ•°æ®åº“

    Client->>Controller: æŸ¥è¯¢è¯·æ±‚(PictureQueryRequest)
    Controller->>Controller: å‚æ•°æ ¡éªŒ

    alt æ™®é€šç”¨æˆ·
        Controller->>Controller: è®¾ç½®åªæŸ¥è¯¢å®¡æ ¸é€šè¿‡çš„å›¾ç‰‡
    end

    Controller->>Service: æ„å»ºæŸ¥è¯¢æ¡ä»¶
    Service->>Service: åˆ›å»ºQueryWrapper
    Service->>Service: æ·»åŠ è¿‡æ»¤æ¡ä»¶

    Service->>DB: æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
    DB-->>Service: è¿”å›å›¾ç‰‡åˆ—è¡¨

    Service->>Service: è½¬æ¢ä¸ºPictureVoåˆ—è¡¨
    Service-->>Controller: è¿”å›åˆ†é¡µç»“æœ
    Controller-->>Client: è¿”å›æŸ¥è¯¢ç»“æœ
```

#### 11.3.2 æŸ¥è¯¢æ¡ä»¶æ„å»ºæµç¨‹

```mermaid
flowchart TD
    A[æŸ¥è¯¢è¯·æ±‚] --> B[æå–æŸ¥è¯¢å‚æ•°]

    B --> C[åˆ›å»ºQueryWrapper]

    C --> D{æ˜¯å¦æœ‰å…³é”®è¯}
    D -->|æ˜¯| E[æ·»åŠ å…³é”®è¯æ¡ä»¶]

    C --> F{æ˜¯å¦æœ‰æ ‡ç­¾}
    F -->|æ˜¯| G[æ·»åŠ æ ‡ç­¾æ¡ä»¶]

    C --> H{æ˜¯å¦æœ‰åˆ†ç±»}
    H -->|æ˜¯| I[æ·»åŠ åˆ†ç±»æ¡ä»¶]

    C --> J{æ˜¯å¦æœ‰æ—¶é—´èŒƒå›´}
    J -->|æ˜¯| K[æ·»åŠ æ—¶é—´æ¡ä»¶]

    C --> L{æ˜¯å¦æœ‰å®¡æ ¸çŠ¶æ€}
    L -->|æ˜¯| M[æ·»åŠ çŠ¶æ€æ¡ä»¶]
    L -->|å¦| N[æ™®é€šç”¨æˆ·é»˜è®¤åªæŸ¥å®¡æ ¸é€šè¿‡]

    E --> O[æœ€ç»ˆæŸ¥è¯¢æ¡ä»¶]
    G --> O
    I --> O
    K --> O
    M --> O
    N --> O

    O --> P[æ‰§è¡ŒæŸ¥è¯¢]
```

#### 11.3.3 æ•°æ®è½¬æ¢æµç¨‹

```mermaid
flowchart TD
    A[æ•°æ®åº“ç»“æœ] --> B[Pictureå®ä½“åˆ—è¡¨]

    B --> C[å¾ªç¯å¤„ç†]

    C --> D[å•ä¸ªPictureå®ä½“]
    D --> E[åˆ›å»ºPictureVo]

    E --> F[å¤åˆ¶åŸºæœ¬å±æ€§]
    E --> G[å¤„ç†æ ‡ç­¾JSON]
    E --> H[æ·»åŠ ç”¨æˆ·ä¿¡æ¯]

    F --> I[PictureVoå¯¹è±¡]
    G --> I
    H --> I

    I --> J[PictureVoåˆ—è¡¨]

    J --> K[æ„å»ºåˆ†é¡µç»“æœ]
    K --> L[æœ€ç»ˆå“åº”]
```

### 11.4 å›¾ç‰‡ç¼–è¾‘æµç¨‹è¯¦è§£

#### 11.4.1 è¯·æ±‚-å“åº”æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Controller as PictureController
    participant Service as PictureService
    participant DB as æ•°æ®åº“

    Client->>Controller: ç¼–è¾‘è¯·æ±‚(PictureEditRequest)
    Controller->>Controller: å‚æ•°æ ¡éªŒ

    Controller->>Service: è½¬æ¢ä¸ºPictureå®ä½“
    Service->>Service: éªŒè¯å›¾ç‰‡æ•°æ®

    Controller->>DB: æŸ¥è¯¢åŸå›¾ç‰‡ä¿¡æ¯
    DB-->>Controller: è¿”å›åŸå›¾ç‰‡æ•°æ®

    Controller->>Controller: æƒé™æ ¡éªŒ(æœ¬äººæˆ–ç®¡ç†å‘˜)

    Controller->>Service: è®¾ç½®å®¡æ ¸å‚æ•°
    Service->>Service: è®¾ç½®ç¼–è¾‘æ—¶é—´
    Service->>Service: é‡ç½®å®¡æ ¸çŠ¶æ€

    Controller->>DB: æ›´æ–°å›¾ç‰‡è®°å½•
    DB-->>Controller: æ›´æ–°æˆåŠŸ

    Controller-->>Client: è¿”å›ç¼–è¾‘ç»“æœ
```

#### 11.4.2 æƒé™æ§åˆ¶æµç¨‹

```mermaid
flowchart TD
    A[ç¼–è¾‘è¯·æ±‚] --> B[è·å–ç™»å½•ç”¨æˆ·]
    B --> C[è·å–åŸå›¾ç‰‡ä¿¡æ¯]

    C --> D{å›¾ç‰‡æ˜¯å¦å­˜åœ¨}
    D -->|å¦| E[è¿”å›NOT_FOUND]
    D -->|æ˜¯| F{æƒé™æ£€æŸ¥}

    F --> G{æ˜¯åˆ›å»ºè€…?}
    F --> H{æ˜¯ç®¡ç†å‘˜?}

    G -->|æ˜¯| I[å…è®¸ç¼–è¾‘]
    H -->|æ˜¯| I

    G -->|å¦| J{æ˜¯ç®¡ç†å‘˜?}
    J -->|å¦| K[è¿”å›NO_AUTH]
    J -->|æ˜¯| I

    I --> L[æ‰§è¡Œç¼–è¾‘æ“ä½œ]
    L --> M[è¿”å›ç¼–è¾‘ç»“æœ]
```

#### 11.4.3 ç¼–è¾‘åçŠ¶æ€å¤„ç†

```mermaid
stateDiagram-v2
    [*] --> ç¼–è¾‘å‰çŠ¶æ€

    ç¼–è¾‘å‰çŠ¶æ€ --> ç¼–è¾‘æ“ä½œ: ç”¨æˆ·ç¼–è¾‘

    ç¼–è¾‘æ“ä½œ --> å¾…å®¡æ ¸çŠ¶æ€: æ™®é€šç”¨æˆ·ç¼–è¾‘
    ç¼–è¾‘æ“ä½œ --> ä¿æŒåŸçŠ¶æ€: ç®¡ç†å‘˜ç¼–è¾‘

    å¾…å®¡æ ¸çŠ¶æ€ --> å®¡æ ¸æµç¨‹: ç­‰å¾…å®¡æ ¸
    ä¿æŒåŸçŠ¶æ€ --> [*]: ç»“æŸæµç¨‹

    å®¡æ ¸æµç¨‹ --> [*]: ç»“æŸæµç¨‹
```

### 11.5 å›¾ç‰‡åˆ é™¤æµç¨‹è¯¦è§£

#### 11.5.1 è¯·æ±‚-å“åº”æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Controller as PictureController
    participant Service as PictureService
    participant DB as æ•°æ®åº“

    Client->>Controller: åˆ é™¤è¯·æ±‚(IdRequest)
    Controller->>Controller: å‚æ•°æ ¡éªŒ

    Controller->>DB: æŸ¥è¯¢å›¾ç‰‡ä¿¡æ¯
    DB-->>Controller: è¿”å›å›¾ç‰‡æ•°æ®

    Controller->>Controller: æƒé™æ ¡éªŒ(æœ¬äººæˆ–ç®¡ç†å‘˜)

    alt é€»è¾‘åˆ é™¤
        Controller->>DB: æ›´æ–°isDeleteæ ‡å¿—
    else ç‰©ç†åˆ é™¤
        Controller->>DB: åˆ é™¤å›¾ç‰‡è®°å½•
    end

    DB-->>Controller: åˆ é™¤æˆåŠŸ
    Controller-->>Client: è¿”å›åˆ é™¤ç»“æœ
```

#### 11.5.2 åˆ é™¤æƒé™æ§åˆ¶

```mermaid
flowchart TD
    A[åˆ é™¤è¯·æ±‚] --> B[å‚æ•°æ ¡éªŒ]
    B -->|å¤±è´¥| C[è¿”å›PARAMS_ERROR]
    B -->|æˆåŠŸ| D[æŸ¥è¯¢å›¾ç‰‡ä¿¡æ¯]

    D --> E{å›¾ç‰‡æ˜¯å¦å­˜åœ¨}
    E -->|å¦| F[è¿”å›NOT_FOUND]
    E -->|æ˜¯| G[è·å–ç™»å½•ç”¨æˆ·]

    G --> H{æƒé™æ£€æŸ¥}
    H --> I{æ˜¯åˆ›å»ºè€…?}
    H --> J{æ˜¯ç®¡ç†å‘˜?}

    I -->|æ˜¯| K[å…è®¸åˆ é™¤]
    J -->|æ˜¯| K

    I -->|å¦| L{æ˜¯ç®¡ç†å‘˜?}
    L -->|å¦| M[è¿”å›NO_AUTH]
    L -->|æ˜¯| K

    K --> N[æ‰§è¡Œåˆ é™¤æ“ä½œ]
    N --> O[è¿”å›åˆ é™¤ç»“æœ]
```

### 11.6 å›¾ç‰‡æ ‡ç­¾å’Œåˆ†ç±»ç®¡ç†

#### 11.6.1 æ ‡ç­¾åˆ†ç±»æ•°æ®æµ

```mermaid
flowchart TD
    A[å®¢æˆ·ç«¯è¯·æ±‚] --> B[è·å–æ ‡ç­¾å’Œåˆ†ç±»]

    B --> C[PictureController]
    C --> D[æ„å»ºPictureTagCategory]

    D --> E[è®¾ç½®æ ‡ç­¾åˆ—è¡¨]
    D --> F[è®¾ç½®åˆ†ç±»åˆ—è¡¨]

    E --> G[PictureTagCategoryå¯¹è±¡]
    F --> G

    G --> H[è¿”å›å“åº”]
```

#### 11.6.2 æ ‡ç­¾ä½¿ç”¨æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Controller as PictureController
    participant Service as PictureService

    Client->>Controller: è·å–æ ‡ç­¾åˆ†ç±»
    Controller->>Controller: æ„å»ºæ ‡ç­¾åˆ†ç±»æ•°æ®
    Controller-->>Client: è¿”å›æ ‡ç­¾åˆ†ç±»

    Client->>Client: ç”¨æˆ·é€‰æ‹©æ ‡ç­¾

    Client->>Controller: ä¸Šä¼ /ç¼–è¾‘å›¾ç‰‡(å¸¦æ ‡ç­¾)
    Controller->>Service: å¤„ç†å›¾ç‰‡
    Service->>Service: ä¿å­˜æ ‡ç­¾(JSONæ ¼å¼)
    Service-->>Controller: è¿”å›å¤„ç†ç»“æœ
    Controller-->>Client: è¿”å›æ“ä½œç»“æœ
```

### 11.7 å›¾ç‰‡æ¨¡å—æ¶ˆæ¯æµè½¬æ€»ç»“

```mermaid
graph TD
    A[å®¢æˆ·ç«¯] --> B[HTTPè¯·æ±‚]
    B --> C[Controllerå±‚]

    C --> D[å‚æ•°æ ¡éªŒ]
    D --> E[æƒé™æ ¡éªŒ]
    E --> F[ä¸šåŠ¡å¤„ç†]

    F --> G[Serviceå±‚]
    G --> H[æ•°æ®å¤„ç†]
    H --> I[å­˜å‚¨äº¤äº’]

    I --> J[æ•°æ®åº“]
    I --> K[æ–‡ä»¶å­˜å‚¨]

    J --> L[æ•°æ®è¿”å›]
    K --> L

    L --> M[æ•°æ®è½¬æ¢]
    M --> N[å“åº”æ„å»º]

    N --> O[HTTPå“åº”]
    O --> P[å®¢æˆ·ç«¯]

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style P fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#bbf,stroke:#333,stroke-width:2px
    style G fill:#bbf,stroke:#333,stroke-width:2px
    style J fill:#bfb,stroke:#333,stroke-width:2px
    style K fill:#bfb,stroke:#333,stroke-width:2px
```

### 11.8 ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ä¼˜åŒ–**ï¼š

   - çƒ­é—¨å›¾ç‰‡ç¼“å­˜
   - æ ‡ç­¾åˆ†ç±»ç¼“å­˜
   - æŸ¥è¯¢ç»“æœç¼“å­˜

2. **æ‰¹é‡æ“ä½œ**ï¼š

   - æ‰¹é‡å®¡æ ¸åŠŸèƒ½
   - æ‰¹é‡æ ‡ç­¾ç®¡ç†
   - æ‰¹é‡åˆ é™¤åŠŸèƒ½

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š

   - å›¾ç‰‡å‹ç¼©å¤„ç†
   - å›¾ç‰‡æ‡’åŠ è½½
   - åˆ†å¸ƒå¼å­˜å‚¨

4. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
   - æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
   - è¿›åº¦æ¡æ˜¾ç¤º
